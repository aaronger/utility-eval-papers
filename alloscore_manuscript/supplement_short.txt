\documentclass{article}

\usepackage[letterpaper,top=2cm,bottom=2cm,left=3cm,right=3cm,marginparwidth=1.75cm]{geometry}

\usepackage{amsmath, amsfonts, amssymb, mathtools}
\usepackage{accents}
\usepackage{graphicx}
\usepackage{algorithm}
\usepackage[noend]{algpseudocode}
\usepackage{amsthm}
\usepackage{bm}
\usepackage{cases}
\usepackage{caption}
\usepackage{soul}
\usepackage{tikz}
\usepackage{pgfplots}
\usepackage{float}
\usepackage{xr-hyper}
\usepackage{hyperref}
\externaldocument{alloscore-application-shorter}

\usepackage{enumitem}
\newlist{todolist}{itemize}{2}
\setlist[todolist]{label=$\square$}
\usepackage{pifont}
\newcommand{\cmark}{\ding{51}}%
\newcommand{\xmark}{\ding{55}}%
\newcommand{\done}{\rlap{$\square$}{\raisebox{2pt}{\large\hspace{1pt}\cmark}}%
\hspace{-2.5pt}}
\newcommand{\wontfix}{\rlap{$\square$}{\large\hspace{1pt}\xmark}}

\DeclareMathOperator*{\argmin}{argmin}
\DeclareMathOperator{\short}{sh}
\DeclareMathOperator{\Ex}{\mathbb{E}}


\usepackage{setspace}


\usepackage{parskip}

\usepackage{soul}
\usepackage{xcolor}
\def\elr#1{{\color{cyan}\textbf{ELR:[#1]}}}
\def\apg#1{{\color{red}\textbf{APG:[#1]}}}
\def\bwr#1{{\color{violet}\textbf{BWR:[#1]}}}
\def\ngr#1{{\color{blue}\textbf{NGR:[#1]}}}

\usepackage{natbib}
\bibliographystyle{unsrtnat}

\title{Supplementary Material for ``Evaluating infectious disease forecasts with allocation scoring rules''}
\author{Aaron Gerding, Nicholas G. Reich, Benjamin Rogers, Evan L. Ray}

\begin{document}

\newcommand{\del}[2]{\frac{\partial {#1} }{\partial {#2}} }
\newcommand{\dby}[2]{\frac{d {#1} }{d {#2}} }
\newcommand{\sbar}{\overline{s}}

\newtheorem{proposition}{Proposition}

\theoremstyle{remark}
\newtheorem*{remark}{Remark}

\maketitle

\begin{todolist}
\item 2 actual references to supplement (re exponential quantiles and solving the allocation problem)
\item the statement that "we computed the allocation score for the 14 day-ahead forecast" which needs some answer to "how?"
\item use of "proper" a number of times
\end{todolist}

\begin{abstract}
We briefly address some technical and methodological points in the main text, referring to the forthcoming ... for 
more thorough discussion.
\end{abstract}


\section{Introduction}
\label{sec:intro}

We briefly address some technical and methodological points in the main text. We begin in section \ref{sec:shortage} by formalizing the concept of a \emph{shortage} of resources and giving some key results about expected resource shortages under a distribution characterizing uncertainty about (future) levels of resource need. Resource shortages play a central role in the decision-making problems that give rise to the quantile loss and the allocation score, which we discuss in sections \ref{sec:quantiles_shortage} and \ref{sec:bayes-quantiles} respectively. Section \ref{sec:numeric} gives details on the numerical methods that we use to calculate allocation scores, including some special considerations for settings where forecasts are represented by a finite collection of predictive quantiles, such as the application to forecasts of hospitalizations due to COVID-19 in section 3 of the article.

\section{Proper scoring rules}
In decision theory, a loss function $l$ is used to formalize a decision problem by assigning numerical value $l(x,y)$ to the 
\emph{result} of taking an \emph{action} $x$ in preparation for an \emph{outcome} $y$. A \emph{scoring rule} $S$ is a 
loss function for a decision problem where the action is a probabilistic forecast $F$ of the outcome $y$ (or the statement of $F$ by a forecaster). 
% As does any loss fun $S$ transforms a random outcome variable $Y$ into a random loss $S(F,Y)$. 
We refer to the realized loss $S(F,y)$ as the \emph{score} of $F$ at $y$.

Decision theoretically, probabilistic forecasts are a unique kind of action in that they can be used to generate their
own (simulated) outcome data, against which they can be scored using $S$. A probabilistic forecast
$F$ is thus committed to the ``self-assessment'' $\Ex_F [S(F, Y)] := \Ex [S(F, Y^F)]$, where $Y^F \sim F$ is the random variable defined 
by sampling from $F$, as well to an assessment $\Ex_F [S(G, Y)]$ of any alternative forecast $G$.

A natural consistency criterion for $S$ is that it does not commit $F$ to assessing any other forecast $G$ 
as being better than $F$ itself, that is, that
\begin{align}
\Ex_F [S(F, Y)] \leq \Ex_F [S(G, Y)] \label{eqn:prop_ineq}
\end{align} 
for any $F,G$. A scoring rule meeting this criterion is called \emph{proper}. If $S$ were improper, then from the perspective of 
a forecaster focussed (solely) on expected loss minimization (which we will call an ELM forecaster), the decision to state 
a forecast $G$ other than the forecast $F$ which they believe describes $Y$ could be superior to the decision to state $F$. 
$S$ is \emph{strictly proper} when 
\eqref{eqn:prop_ineq} is sharp, in which case the 
\emph{only} optimal decision for an ELM forecaster is to state the forecast they believe to be true.

\subsection{The allocation score is proper}
\label{sec:alloscore_proper}

Our primary decision theoretical procedure, outlined in section \ref{sec:methods.detailed.decisiontheory} of the main text, 
uses a decision problem with loss function $s(x,y)$ to define a scoring rule 
\begin{align}
S(F,y) := s(x^F,y) \label{eqn:bayes_sr}
\end{align}
where $x^F := \argmin_{x} \Ex_F[s(x,Y)]$ is the Bayes act for $F$ with respect to $s$. 
Such scoring rules, which we call \emph{Bayes scoring rules}, 
are proper by construction since
\begin{align}
\Ex_F [S(F, Y)] &= \Ex_F [ s(x^F, Y) ] \nonumber \\
 &= \mathrm{min}_{x} \Ex_F [ s(x, Y) ] \quad \text{ (by definition of $x^F$)} \\
 &\leq \Ex_F [ s(x^G, Y) ] \label{eqn:dt_proper_key} \\
 &= \Ex_F [ S(G, Y)]. \nonumber
\end{align}

The allocation scoring rule is Bayes and therefore proper.

We note that in the probabilistic forecasting literature (see e.g., \cite{gneiting2011making}, Theorem 3) what we have 
termed Bayes scoring rules typically appear via \eqref{eqn:bayes_sr} where $x^F$ is some given functional of $F$ which 
can be shown to be \emph{elicitable}, that is, to be the Bayes act for some loss function $s$.
Such a loss function is said to be a \emph{consistent loss (or scoring) function} for the functional $F \mapsto x^F$, and many important
recent results in the literature (e.g., \cite{fisslerziegel2016consistency}) address whether there \emph{exists} any loss 
function for $x^F$ which is consistent. Our orientation
is different from this insofar as we \emph{begin} by specifying a decision problem and a loss function of subject matter relevance
and use the Bayes act only as a bridge to a proper scoring rule.  Consistency is never in doubt.


\section{Expected shortages}
\label{sec:ex-shortage}

A key feature of loss functions used in the decision theoretic definition of quantiles and related scoring rules such as the 
CRPS and the WIS (see ...), as well as the allocation loss function presented in this work, is the presence of a \emph{shortage}: 
the amount $\max\{0,y-x\}$ by which a random resource demand 
$y$ exceeds a supply decision variable $x$, which, for convenience, we write as $(y-x)_{+}$. In particular, a quantile at 
probability level $\alpha$ of a distribution $F$ on $\mathbb{R}^1$ (which we assume to have a well-defined density $f(x)$) 
is a Bayes act for the loss function
\[
l(x,y) = Cx + L(y-x)_{+}
\] 
where $\alpha = 1-C/L$ and $C$ and $L$ can be interpreted as the cost per unit of a resource (such as medicine) and the loss
incurred when a unit of demand (such as illness) cannot be met due to the shortage $(y-x)_{+}$.  This follows because a 
Bayes act, as a minimizer of $\Ex_F[l(x,Y)]$, must also be a vanishing point of the derivative
\begin{align}
\dby{}{x} \Ex_F\left[l(x,Y)\right] &= \Ex_F\left[\dby{}{x}l(x,Y)\right] \nonumber\\
&= C + L\Ex_F\left[\dby{}{x}(Y-x)_+\right] \nonumber\\
&= C - L\Ex_F\left[\mathbf{1}\{Y > x\}\right] \nonumber\\
&= C + L(F(x) - 1), \label{eqn:q_deriv}
\end{align}
so that $1-C/L = F(x)$.
The formula $\dby{}{x}\Ex_F\left[(Y-x)_+\right] = F(x) - 1$ for the derivative of the shortage 
which we use below in deriving the Bayes act for the allocation
loss, can be seen as following, as indicated above in \eqref{eqn:q_deriv}, from a probability theoretic definition of the expectation operator on piecewise defined functions, or as application of the ``Leibniz Rule''
\begin{align}
	\frac{d}{dx} \Ex_F [(Y-x)_{+}] &= \frac{d}{dx} \int_{x}^{\infty} (y-x) f_Y(y)dy \nonumber\\
	&= \int_{x}^{\infty} \frac{d}{dx}(y-x) f_Y(y)dy - (x-x) f_Y(x) = -\int_{x}^{\infty} f_Y(y)dy = F(x)-1. \label{eqn:shortage_deriv}
\end{align}
(Note that more care is required when $F$ does not have a density.) 


\section{Allocation Bayes acts as vectors of marginal quantiles.}
\label{sec:bayes-quantiles}

Here we show that the Bayes act $x^{F,K} = (x_1^{F,K},\ldots,x_N^{F,K})$ for a forecast $F$, corresponding to the
allocation problem (AP) (\eqref{eqn:loss_fn} in section \ref{sec:methods.detailed.specific_allocation})
\begin{align}
    \underset{0 \leq x}{\mathrm{minimize}}\,\, \mathbb{E}_{F} [s_A(x, Y)]= \sum_{i=1}^{N} L \cdot \mathbb{E}_{F_i}[(Y_i - x_i)_{+}] 
     \text{ subject to }
     \, \sum_{i=1}^N x_i = K, \label{AP}
\end{align}
can be represented as a vector of quantiles for the marginal forecast distributions $F_i$ at a single probability level
$\tau^{F,K}$, that is, $x_i^{F,K} = q_{F_i,\tau^{F,K}}$. An immediate consequence used in the examples in Section \ref
{sec:methods.overview} in the main text is that if $F_i = \mathrm{Exp}(1/\sigma_i)$ for all $i$, then the Bayes act is
proportional to $(\sigma_1,\ldots,\sigma_N)$, since $q_{\mathrm{Exp}(1/\sigma),\tau} = -\sigma \log(1-\tau)$.

In order for $x^{\star} \in \mathbb{R}^N_{+}$ to solve the AP it must be true that reallocatating $\delta > 0$ of the 
$x_i^{\star}$ units of resource allocated to location $i$ to location $j$ will increase the expected shortage in location
$i$ by at least as much as it decreases the expected shortage in location $j$. Letting $\delta \searrow 0$, this implies from
\eqref{eqn:shortage_deriv} that

\begin{align}
1-F_i(x^{\star}_i) &= -\frac{d}{dx_i}\mathbb{E}_{F_i}[(Y_i - x^{\star}_i)_{+}] \nonumber \\
&= \lim_{\delta \searrow 0} \frac{1}{\delta}
\left\{\mathbb{E}_{F_i}[(Y_i - (x^{\star}_i - \delta))_{+}] - \mathbb{E}_{F_i}[(Y_i - x^{\star}_i)_{+}]\right\} 
\text{ (increase in $i$) } \nonumber \\
&\geq 
\lim_{\delta \searrow 0} \frac{1}{\delta} 
\left\{\mathbb{E}_{F_j}[(Y_j - x^{\star}_j)_{+}] - \mathbb{E}_{F_j}[(Y_j - (x^{\star}_j + \delta))_{+}]\right\} 
\text{ (decrease in $j$) } \nonumber \\
 &= -\dby{}{x_j}\mathbb{E}_{F_j}[(Y_j - x^{\star}_j)_{+}] = 1-F_j(x^{\star}_j) \label{eqn:ASoptimal1}
\end{align}

Note that negative derivatives appear because our optimality condition addresses how a \emph{decrease} in resources will 
\emph{increase} the expected shortage in $i$ and vice versa in $j$. Since \eqref{eqn:ASoptimal1} holds with $i$ and $j$ 
reversed, a number $\lambda$ (a \emph{Lagrange multiplier}) exists such that
$L(1-F_k(x^{\star}_k)) = \lambda$ for all $k \in 1,\ldots,N$.
(We scale by $L$ to facilitate possible future interpretations of $\lambda$ in terms of the partial derivatives 
of $\mathbb{E}_{F} [s_A(x, Y)]$.)
That is, $x^{\star}_k$ is a quantile $q_{\tau,F_k}$ for
$\tau = 1 - \lambda/L$. The value of $\tau$ is then determined by the constraint equation 
\begin{align}
\sum_{i=1}^N q_{\tau,F_i} = K.
\end{align}
It is important to note that $\tau$ depends on $F$ and $K$ and is \emph{not} a fixed parameter
of the allocation scoring rule.
\newpage

\section{Propriety of parametric approximation} % (fold)
\label{sec:propriety_of_parametric_approximation}

For convenience we write $S(F,G) := \Ex_G[S(F,Y)]$. Let
\begin{align*}
q_{23}(F) &:= (q_{.01,F},\ldots,q_{.99,F}) \\
G^q(F) &:= G_{q_{23}(F)} \in \mathcal{P}_{\mathrm{dfq}} \\
G^{\star}(F) &:= \argmin_{G \in \mathcal{P}_{\mathrm{dfq}}} S_A(G,F)
\end{align*}
We have the ``right'' approximate allocation score
\begin{align*}
S_{R}(F,y):= S_A(G^{\star}(F),y)
\end{align*}
which is proper because 
\begin{align*}
S_R(F,F) &= S_A(G^{\star}(F), F) \\ 
&\leq S_A(G^{\star}(F), H) \quad \text{ (by definition of $G^{\star}$)} \\
&=S_R(F,H).
\end{align*}
This seems to almost be what is called ``properization'' in \cite{brehmer2020properization}.
We also have a ``wrong'' approximation 
\begin{align*}
\tilde{S}_R(F,y) := S_A(G^q(F),y)
\end{align*}
which is improper because
\begin{align*}
\tilde{S}_R(F,G^q(F)) &= S_A(G^q(F),G^q(F)) \\
 &<  S_A(G^q(F),F) \quad \text{ (because $S_A$ is proper)} \\
 &= \tilde{S}_R(F,F).
\end{align*}




% section propriety_of_parametric_approximation (end)

\bibliography{allocation}

\end{document}
