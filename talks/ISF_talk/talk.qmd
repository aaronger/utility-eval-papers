---
title: "alloscore, ISF 43"
format:
  revealjs: 
    width: 1500
revealjs-plugins:
  - attribution
editor: visual
css: styles.css
---

## Evolution of ID Forecasting Hubs {.nostretch}

![](hub_timeline.png){}

::: {.attribution}
Figure credits: Alex Vespignani and Nicole Samay
:::

::: notes
West Nile mosq control decisions
:::

## The Role of IDF Hubs

Outbreak forecasting hubs developed to **"inform public health responses"**

- with trend toward elicitation of probabilistic forecasts

- uncertainty quantification essential to a public health **DM** (decision maker)

But in the inimitable words of chatGPT:

> It's important to note that while these efforts represent significant advances in the field, forecasting the spread and impact of infectious diseases is a very complex task with many challenges, and these models should be interpreted with caution.

::: notes
Over last two decades, multicenter effort to collect forecasts via hubs for ID outbreaks (epi/pan/endemic) with central purpose to "inform public health responses"

With uncertainty quantification being well-established as needed DM input,
:::

## The fundamental need to decide allocations

Basic element of any such response is an **allocation decision** regarding

::: columns

::: {.column width="10%"}

<div style="height: 200px; width: 50px;">
  <svg height="100%" width="100%" viewBox="0 0 10 20">
    <line x1="5" y1="0" x2="5" y2="15" style="stroke:black;stroke-width:2" />
    <polygon points="0,20 10,20 5,15" style="fill:black;" />
  </svg>
</div>


:::

::: {.column width="40%"}

-   medical supplies
-   personnel
-   facility capacity
-   R&D funding
-   public tolerance for NPIs
:::

::: {.column width="50%"}
Similar to other contexts where there are large-scale institutional efforts to use expert judgment to assess and manage social risk

-   finance
-   meteorology
-   military conflict
:::
:::

::: notes
Allocations can be wrt space, time, demographic

Even with complex game-theoretic approachs to collective decision making, allocation almost always a requirement to strategy development
:::

## Scoring rules and social utility

*Very* briefly, a **scoring rule** $S$ assigns a number $S(F,y)$ to the forecast $F$ of $Y$ when $Y=y$ is realized.

$S$ if **proper** if $\displaystyle{E_{F}[S(F,Y)] \leq E_{G}S(F,Y)]}$ for all $F, G$

- ensures that forecasters must give honest forecasts to maximize expected score

Hubs have tried to use SRs to rank and combine forecasts in ways that offer best suppport for PH response to ID outbreaks

Primary scoring rule used currently is the **Weighted Interval Score** which is a discrete approximation to the 
**Continuous Ranked Probability Score**

- adopted for convenient scoring of quantile forecasts.

## Bayes Acts

Scoring rules can be cast in decision-theoretic framework of **Bayes acts**.

::: {.important}

The **Bayes act** relative to a forecast $Y \sim F$ is the action $x^F$ 
by which a DM will minimize **expected loss** $E_Y[l]$ assuming that in reality $Y \sim F$.

:::


 - loss $l$ is a function of the outcome $y$ **and** the action $x$ DM takes in anticipation of $y$

Given $l$, we have an *automatically proper* scoring rule $S(F,y) := l(x^F, y)$.

::: {.callout-note appearance="simple" icon=false}

### Our running example:
 
 - $x$ and $y$ are vectors in $\mathbb{N}_0^{52}$
 - $y =$ number of severe cases in US states and territories
 - $l(x,y) =$ unmet need when $x < y$ beds are allocated and $y$ severe cases occur

:::

## Formally

$$
\begin{align}
l(x,y) &= \sum_{i=1}^{52} \max(y_i - x_i, 0) \\
x^F &\in \left\{ \text{possible } x' \,\middle| \, E_{F}[l(x',Y)] \leq E_{F}[l(x,Y)] \text{ for any possible } x \right\}
\end{align}
$$

Novelty of our approach for ID forecasting is how we define $x$ being 
**possible**

 - as satisfying some resource constraint $\displaystyle{\sum x_i \leq K}$

::: {.callout-note appearance="simple" icon=false}

### Note:

Our loss function and (single) constraint are very simple prototypes meant 
for proof of concept. 

:::

::: notes
social/political/economic/psychological/moral utility

this must somehow acknowledge risk attitude heterogeneity among various DM's that a forecast hub might serve

gpl parameters, weights, multiple constraints
:::

## Sharing Business

A Scoring Rule attempts to "share" DM loss with the forecaster through $S(F,y)$

- idea goes back to Savage

- may be in units of money, goodwill, prestige

::: {.callout-note appearance="Important" icon=false}

## A central goal in design of scoring rules for social good

Create scenario where the forecaster believes maximizing her own expected utility aligns 
with leading the DM toward actions that maximize social utility.

:::

Using an explicit vacabulary of social loss in ID forecasting hub activities has instrinsic advantage
over use of "off-the-shelf" statistical functionals from statistic inference

::: notes
$S$ a penalty for us 

inference has own decision theory and ideas of utility, loss, Bayes acts
that are related but distinct from the fundamentally econommic/policy focussed
ones we use here
:::

## A Lagrangian formulation for the Bayes act

Given $F = \{F_i\}_{i=1}^{N}$, obtaining $x^F$ is a constrained stochastic optimization problem 

$$ 
\begin{align}
L(x, \lambda ; K, F) &= \sum_{i=1}^N E_{F_i}\left[l(x_i, Y_i)]\right)+\lambda\left(\sum_{i=1}^N x_i-K\right) \\  
\nabla_{x} L = 0 &\implies 
E_F \left[\frac{d}{dx_i}(Y_i - x_i)_{+}\right] + \lambda 
= F_i(x_i)-1 + \lambda = 0 \\
&\implies x_i = F_i^{-1}(1-\lambda)
\end{align}
$$


Solve $\sum_{l=1}^{N} F_{i}^{-1}(1-\lambda) = K$ to get $x_{i}^F = F_i^{-1}(1-\lambda^{\star})$

## Basic computational approach

Even for simple parametric $F_i$, this rarely has an analytic solution.

Given quantile forecasts $q_{i,j}, j = 1,\ldots,23$, we interpolate full $F_i$ to form $L(x, \lambda ; K, F)$

Adopt an iterative Lagrange multiplier method following long history in inventory management of solving **constrained multi-product newsvendor** problems

illustrate algo with a lambda over xs plot against tau


## Application

December 2021: Omicron wave clearly started US but forecast teams unsure of severity given uncertainty about $R_0$, cross-protection by vaccination, previous infection, etc.

___

![](plots/state_hosps_ens_only.jpeg)


## Data workflow

```
# A tibble: 12 × 9
    time model forecast         ys            K xdf              score_raw score_oracle score
   <int> <chr> <list>           <list>    <dbl> <list>               <dbl>        <dbl> <dbl>
 1     1 m1    <tibble [4 × 7]> <dbl [4]>   400 <tibble [4 × 8]>      62.5          0    62.5
 2     1 m1    <tibble [4 × 7]> <dbl [4]>   450 <tibble [4 × 8]>      50.0          0    50.0
 3     2 m1    <tibble [4 × 7]> <dbl [4]>   400 <tibble [4 × 8]>     150.          27.3 122. 
 4     2 m1    <tibble [4 × 7]> <dbl [4]>   450 <tibble [4 × 8]>     137.           0   137. 
 5     3 m1    <tibble [4 × 7]> <dbl [4]>   400 <tibble [4 × 8]>      62.2          0    62.2
 6     3 m1    <tibble [4 × 7]> <dbl [4]>   450 <tibble [4 × 8]>      49.7          0    49.7
 7     1 m2    <tibble [4 × 7]> <dbl [4]>   400 <tibble [4 × 8]>      54.8          0    54.8
 8     1 m2    <tibble [4 × 7]> <dbl [4]>   450 <tibble [4 × 8]>      40.2          0    40.2
 9     2 m2    <tibble [4 × 7]> <dbl [4]>   400 <tibble [4 × 8]>     157.          27.3 130. 
10     2 m2    <tibble [4 × 7]> <dbl [4]>   450 <tibble [4 × 8]>     149.           0   149. 
11     3 m2    <tibble [4 × 7]> <dbl [4]>   400 <tibble [4 × 8]>      74.9          0    74.9
12     3 m2    <tibble [4 × 7]> <dbl [4]>   450 <tibble [4 × 8]>      70.9          0    70.9
```

```
> a_series_slim$xdf[[9]]
# A tibble: 4 × 8
  target_names     x score_fun     y oracle components_raw components_oracle components
  <chr>        <dbl> <list>    <dbl>  <dbl>          <dbl>             <dbl>      <dbl>
1 A             80.4 <fn>       55.0   51.5             0               3.52      -3.52
2 B             92.2 <fn>      250.   234.            157.             16.0      141.  
3 C            106.  <fn>       89.2   83.5             0               5.70      -5.70
4 D            122.  <fn>       33.5   31.3             0               2.14      -2.14
```

## Scoring against an oracle

To get more interpretable allocation scores we adjust by the score of an oracle that allocates *fairly* based on what demands actually occur

Note: The oracle is not the DGP, it is a time-traveller

Comparitive vs absolute assessment/evaluation

## General Disclaimer

This is **post-hoc** analysis

Hub forecasters were unaware of

- an allocation score (on joint forecast)
- any allocation based loss
- our quantile interpolation/extrapolation methods (`distfromq`)

  - might be especially important for tails


<!-- ## Loss vs Utility

Change in loss but not utility from change in - variant severity (assuming target is infections and decision is number of beds)

Change in utility but not in loss from change in - supply and personnel cost structures - public opinion regarding importance of fatality prevention - knowledge of demographic disparities in consequences of outcomes -->









